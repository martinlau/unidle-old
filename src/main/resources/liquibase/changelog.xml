<?xml version="1.0" encoding="UTF-8"?>
<!--
  #%L
  unidle
  %%
  Copyright (C) 2013 Martin Lau
  %%
  This program is free software: you can redistribute it and/or modify
  it under the terms of the GNU Affero General Public License as published by
  the Free Software Foundation, either version 3 of the License, or
  (at your option) any later version.
  
  This program is distributed in the hope that it will be useful,
  but WITHOUT ANY WARRANTY; without even the implied warranty of
  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
  GNU General Public License for more details.
  
  You should have received a copy of the GNU Affero General Public License
  along with this program.  If not, see <http://www.gnu.org/licenses/>.
  #L%
  -->

<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
                   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                   xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.0.xsd">

    <changeSet id="001 hibernate_sequence"
               author="Martin Lau [m@hum.ph]">

        <createSequence sequenceName="hibernate_sequence"/>

    </changeSet>

    <changeSet id="002 users"
               author="Martin Lau [m@hum.ph]">

        <createTable tableName="users">
            <column name="uuid"
                    type="VARCHAR">
                <constraints primaryKey="true"/>
            </column>
            <column name="revision"
                    type="INTEGER">
                <constraints nullable="false"/>
            </column>

            <column name="created_by_user_uuid"
                    type="VARCHAR"/>
            <column name="created_date"
                    type="DATETIME">
                <constraints nullable="false"/>
            </column>
            <column name="last_modified_by_user_uuid"
                    type="VARCHAR"/>
            <column name="last_modified_date"
                    type="DATETIME">
                <constraints nullable="false"/>
            </column>

            <column name="email"
                    type="VARCHAR">
                <constraints nullable="false"
                             unique="true"/>
            </column>
            <column name="first_name"
                    type="VARCHAR"/>
            <column name="last_name"
                    type="VARCHAR"/>
        </createTable>

        <addForeignKeyConstraint baseTableName="users"
                                 baseColumnNames="created_by_user_uuid"
                                 constraintName="fk_users_created_by_user_uuid"
                                 referencedTableName="users"
                                 referencedColumnNames="uuid"/>

        <addForeignKeyConstraint baseTableName="users"
                                 baseColumnNames="last_modified_by_user_uuid"
                                 constraintName="fk_users_last_modified_by_user_uuid"
                                 referencedTableName="users"
                                 referencedColumnNames="uuid"/>

    </changeSet>

    <changeSet id="003 location_facts"
               author="Martin Lau [m@hum.ph]">

        <createTable tableName="location_facts">
            <column name="uuid"
                    type="VARCHAR">
                <constraints primaryKey="true"/>
            </column>
            <column name="revision"
                    type="INTEGER">
                <constraints nullable="false"/>
            </column>

            <column name="created_by_user_uuid"
                    type="VARCHAR"/>
            <column name="created_date"
                    type="DATETIME">
                <constraints nullable="false"/>
            </column>
            <column name="last_modified_by_user_uuid"
                    type="VARCHAR"/>
            <column name="last_modified_date"
                    type="DATETIME">
                <constraints nullable="false"/>
            </column>

            <column name="continent"
                    type="VARCHAR">
                <constraints nullable="false"/>
            </column>
            <column name="country"
                    type="VARCHAR">
                <constraints nullable="false"/>
            </column>
            <column name="subdivision"
                    type="VARCHAR">
                <constraints nullable="false"/>
            </column>
            <column name="city"
                    type="VARCHAR">
                <constraints nullable="false"/>
            </column>
            <column name="location_prefix"
                    type="VARCHAR">
                <constraints nullable="false"/>
            </column>
            <column name="task_time_unit"
                    type="VARCHAR">
                <constraints nullable="false"/>
            </column>
            <column name="task_people"
                    type="INTEGER">
                <constraints nullable="false"/>
            </column>
            <column name="task_duration"
                    type="INTEGER">
                <constraints nullable="false"/>
            </column>
            <column name="task_duration_time_unit"
                    type="VARCHAR">
                <constraints nullable="false"/>
            </column>
            <column name="task_code"
                    type="VARCHAR">
                <constraints nullable="false"/>
            </column>
            <column name="summary_duration"
                    type="INTEGER">
                <constraints nullable="false"/>
            </column>
            <column name="summary_duration_time_unit"
                    type="VARCHAR">
                <constraints nullable="false"/>
            </column>
            <column name="source"
                    type="VARCHAR">
                <constraints nullable="false"/>
            </column>

        </createTable>

        <createIndex tableName="location_facts"
                     indexName="idx_location_facts_city_subdivision_country_continent"
                     unique="true">
            <column name="city"/>
            <column name="subdivision"/>
            <column name="country"/>
            <column name="continent"/>
        </createIndex>

        <createIndex tableName="location_facts"
                     indexName="idx_location_facts_city">
            <column name="city"/>
        </createIndex>

        <createIndex tableName="location_facts"
                     indexName="idx_location_facts_country">
            <column name="country"/>
        </createIndex>

        <createIndex tableName="location_facts"
                     indexName="idx_location_facts_continent">
            <column name="continent"/>
        </createIndex>

        <createIndex tableName="location_facts"
                     indexName="idx_location_facts_subdivision">
            <column name="subdivision"/>
        </createIndex>

        <addForeignKeyConstraint baseTableName="location_facts"
                                 baseColumnNames="created_by_user_uuid"
                                 constraintName="fk_location_facts_created_by_user_uuid"
                                 referencedTableName="users"
                                 referencedColumnNames="uuid"/>

        <addForeignKeyConstraint baseTableName="location_facts"
                                 baseColumnNames="last_modified_by_user_uuid"
                                 constraintName="fk_location_facts_last_modified_by_user_uuid"
                                 referencedTableName="users"
                                 referencedColumnNames="uuid"/>

    </changeSet>

    <changeSet id="004 location_facts data"
               author="Martin Lau [m@hum.ph]">

        <loadData tableName="location_facts"
                  file="liquibase/data/location-facts.csv"/>

    </changeSet>

    <changeSet id="005 user_connections"
               author="Martin Lau [m@hum.ph]">

        <createTable tableName="user_connections">
            <column name="uuid"
                    type="VARCHAR">
                <constraints primaryKey="true"/>
            </column>
            <column name="revision"
                    type="INTEGER">
                <constraints nullable="false"/>
            </column>

            <column name="created_by_user_uuid"
                    type="VARCHAR"/>
            <column name="created_date"
                    type="DATETIME">
                <constraints nullable="false"/>
            </column>
            <column name="last_modified_by_user_uuid"
                    type="VARCHAR"/>
            <column name="last_modified_date"
                    type="DATETIME">
                <constraints nullable="false"/>
            </column>

            <column name="user_uuid"
                    type="VARCHAR">
            </column>
            <column name="provider_id"
                    type="VARCHAR">
                <constraints nullable="false"/>
            </column>
            <column name="provider_user_id"
                    type="VARCHAR"/>
            <column name="rank"
                    type="INTEGER"/>
            <column name="display_name"
                    type="VARCHAR"/>
            <column name="profile_url"
                    type="VARCHAR"/>
            <column name="image_url"
                    type="VARCHAR"/>
            <column name="access_token"
                    type="VARCHAR">
                <constraints nullable="false"/>
            </column>
            <column name="secret"
                    type="VARCHAR"/>
            <column name="refresh_token"
                    type="VARCHAR"/>
            <column name="expire_time"
                    type="BIGINT"/>
        </createTable>

        <addForeignKeyConstraint baseTableName="user_connections"
                                 baseColumnNames="user_uuid"
                                 constraintName="fk_user_connections_user_uuid"
                                 deleteCascade="true"
                                 referencedTableName="users"
                                 referencedColumnNames="uuid"/>

        <createIndex tableName="user_connections"
                     indexName="idx_user_connections_user_uuid_provider_id_provider_user_id"
                     unique="true">
            <column name="user_uuid"/>
            <column name="provider_id"/>
            <column name="provider_user_id"/>
        </createIndex>

        <createIndex tableName="user_connections"
                     indexName="idx_user_connections_user_uuid_provider_id_rank"
                     unique="true">
            <column name="user_uuid"/>
            <column name="provider_id"/>
            <column name="rank"/>
        </createIndex>

        <addForeignKeyConstraint baseTableName="user_connections"
                                 baseColumnNames="created_by_user_uuid"
                                 constraintName="fk_user_connections_created_by_user_uuid"
                                 referencedTableName="users"
                                 referencedColumnNames="uuid"/>

        <addForeignKeyConstraint baseTableName="user_connections"
                                 baseColumnNames="last_modified_by_user_uuid"
                                 constraintName="fk_user_connections_last_modified_by_user_uuid"
                                 referencedTableName="users"
                                 referencedColumnNames="uuid"/>

    </changeSet>

    <changeSet id="006 questions"
               author="Martin Lau [m@hum.ph]">

        <createTable tableName="questions">
            <column name="uuid"
                    type="VARCHAR">
                <constraints primaryKey="true"/>
            </column>
            <column name="revision"
                    type="INTEGER">
                <constraints nullable="false"/>
            </column>

            <column name="created_by_user_uuid"
                    type="VARCHAR"/>
            <column name="created_date"
                    type="DATETIME">
                <constraints nullable="false"/>
            </column>
            <column name="last_modified_by_user_uuid"
                    type="VARCHAR"/>
            <column name="last_modified_date"
                    type="DATETIME">
                <constraints nullable="false"/>
            </column>

            <column name="question"
                    type="VARCHAR">
                <constraints nullable="false"/>
            </column>

        </createTable>

        <addForeignKeyConstraint baseTableName="questions"
                                 baseColumnNames="created_by_user_uuid"
                                 constraintName="fk_questions_created_by_user_uuid"
                                 referencedTableName="users"
                                 referencedColumnNames="uuid"/>

        <addForeignKeyConstraint baseTableName="questions"
                                 baseColumnNames="last_modified_by_user_uuid"
                                 constraintName="fk_questions_last_modified_by_user_uuid"
                                 referencedTableName="users"
                                 referencedColumnNames="uuid"/>

    </changeSet>

    <changeSet id="007 question_tags"
               author="Martin Lau [m@hum.ph]">

        <createTable tableName="question_tags">
            <column name="question_uuid"
                    type="VARCHAR">
                <constraints primaryKey="true"/>
            </column>
            <column name="tag"
                    type="VARCHAR">
                <constraints primaryKey="true"/>
            </column>

        </createTable>

        <addForeignKeyConstraint baseTableName="question_tags"
                                 baseColumnNames="question_uuid"
                                 constraintName="fk_question_tags_question_uuid"
                                 referencedTableName="questions"
                                 referencedColumnNames="uuid"/>

    </changeSet>

    <changeSet id="008 responses"
               author="Martin Lau [m@hum.ph]">

        <createTable tableName="responses">
            <column name="uuid"
                    type="VARCHAR">
                <constraints primaryKey="true"/>
            </column>
            <column name="revision"
                    type="INTEGER">
                <constraints nullable="false"/>
            </column>

            <column name="created_by_user_uuid"
                    type="VARCHAR"/>
            <column name="created_date"
                    type="DATETIME">
                <constraints nullable="false"/>
            </column>
            <column name="last_modified_by_user_uuid"
                    type="VARCHAR"/>
            <column name="last_modified_date"
                    type="DATETIME">
                <constraints nullable="false"/>
            </column>

            <column name="question_uuid"
                    type="VARCHAR">
                <constraints nullable="false"/>
            </column>
            <column name="parent_response_uuid"
                    type="VARCHAR"/>

            <column name="comments"
                    type="VARCHAR">
                <constraints nullable="false"/>
            </column>
            <column name="score"
                    type="INTEGER">
                <constraints nullable="false"/>
            </column>

        </createTable>

        <addForeignKeyConstraint baseTableName="responses"
                                 baseColumnNames="created_by_user_uuid"
                                 constraintName="fk_responses_created_by_user_uuid"
                                 referencedTableName="users"
                                 referencedColumnNames="uuid"/>

        <addForeignKeyConstraint baseTableName="responses"
                                 baseColumnNames="last_modified_by_user_uuid"
                                 constraintName="fk_responses_last_modified_by_user_uuid"
                                 referencedTableName="users"
                                 referencedColumnNames="uuid"/>

    </changeSet>

    <changeSet id="009 response_tags"
               author="Martin Lau [m@hum.ph]">

        <createTable tableName="response_tags">
            <column name="response_uuid"
                    type="VARCHAR">
                <constraints primaryKey="true"/>
            </column>
            <column name="tag"
                    type="VARCHAR">
                <constraints primaryKey="true"/>
            </column>

        </createTable>

        <addForeignKeyConstraint baseTableName="response_tags"
                                 baseColumnNames="response_uuid"
                                 constraintName="fk_response_tags_response_uuid"
                                 referencedTableName="responses"
                                 referencedColumnNames="uuid"/>

    </changeSet>

</databaseChangeLog>
